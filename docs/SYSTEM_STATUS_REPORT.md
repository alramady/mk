# تقرير حالة النظام — المفتاح الشهري
## System Status Report — Monthly Key

**التاريخ:** 27 فبراير 2026
**الغرض:** تقرير صريح عن حالة كل مكون في النظام — ما يعمل وما لا يعمل

---

## ملخص تنفيذي

النظام يحتوي على **3 طبقات** لإدارة العقارات، وهذا هو مصدر التعقيد:

```
┌─────────────────────────────────────────────────┐
│  الطبقة 1: Properties (العقارات - واجهة المستأجر) │
│  → جدول properties في DB                         │
│  → صفحة CreateProperty + PropertyDetail          │
│  → رفع صور عبر property.uploadPhoto              │
│  → هذا ما يراه المستأجر على الموقع               │
├─────────────────────────────────────────────────┤
│  الطبقة 2: Buildings + Units (المباني والوحدات)   │
│  → جداول buildings + units في DB                 │
│  → صفحة AdminBuildings + AdminUnitFinance        │
│  → إدارة مالية + إشغال + KPIs                    │
│  → هذا ما يراه المدير في لوحة التحكم             │
├─────────────────────────────────────────────────┤
│  الطبقة 3: Beds24 Map (ربط Beds24)               │
│  → جدول beds24_map في DB                         │
│  → يربط Unit بـ Beds24 Property/Room             │
│  → مزامنة الحجوزات والتوفر                       │
└─────────────────────────────────────────────────┘
```

**الرابط بينهم:** `units.propertyId` يربط الوحدة بالعقار المعروض للمستأجر.

---

## تفصيل كل مكون

### 1. إنشاء عقار (Property) — من واجهة المالك/المستأجر

| البند | الحالة | التفاصيل |
|-------|--------|----------|
| نموذج الإنشاء | ✅ يعمل | صفحة `CreateProperty.tsx` — 337 سطر |
| رفع الصور | ✅ يعمل | `property.uploadPhoto` → Sharp optimizer → تخزين محلي |
| تحسين الصور | ✅ يعمل | 3 أحجام: thumbnail (400x300), medium (800x600), original (1600x1200) |
| التخزين | ✅ يعمل | ملفات محلية في `uploads/` → تُقدم عبر `/uploads/*` |
| الحقول العربية | ✅ موجودة | titleAr, descriptionAr, addressAr, cityAr, districtAr |
| الموقع على الخريطة | ⚠️ يدوي | latitude/longitude يُدخل يدوياً — لا يوجد Google Maps URL auto-fill |
| الموافقة | ✅ يعمل | العقار يبدأ بحالة "pending" → المدير يوافق أو يرفض |
| عرض العقار | ✅ يعمل | `PropertyDetail.tsx` يعرض كل التفاصيل والصور |

**الخلاصة:** إنشاء العقار من واجهة المالك **يعمل بشكل صحيح**. الصور تُرفع وتُحفظ محلياً.

---

### 2. إنشاء مبنى (Building) — من لوحة تحكم المدير

| البند | الحالة | التفاصيل |
|-------|--------|----------|
| نموذج الإنشاء | ✅ الكود موجود | `AdminBuildings.tsx` — BuildingForm component |
| جدول buildings في DB | ❌ **غير موجود في الإنتاج** | `Table 'railway.buildings' doesn't exist` |
| Google Maps URL | ✅ تم إضافته | (في التحديث الأخير — لم يُدفع بعد) |
| الحقول العربية | ✅ موجودة | buildingNameAr, cityAr, districtAr, addressAr |
| رفع صور المبنى | ❌ **غير موجود** | لا يوجد حقل صور في جدول buildings |
| KPIs المبنى | ✅ الكود موجود | لكن يعتمد على وجود الجدول |

**المشكلة الرئيسية:** جدول `buildings` غير موجود في قاعدة البيانات الإنتاجية. يجب تشغيل `drizzle-kit push` أو migration.

---

### 3. إنشاء وحدة (Unit) — من لوحة تحكم المدير

| البند | الحالة | التفاصيل |
|-------|--------|----------|
| نموذج الإنشاء | ✅ الكود موجود | `AdminUnitFinance.tsx` — NewUnit component |
| جدول units في DB | ❌ **غير موجود في الإنتاج** | يعتمد على جدول buildings |
| ربط بـ Property | ✅ حقل propertyId | يربط الوحدة بالعقار المعروض |
| ربط بـ Beds24 | ✅ الكود موجود | `Beds24MappingSection` في AdminUnitFinance |
| رفع صور الوحدة | ❌ **غير موجود** | لا يوجد حقل صور في جدول units |

---

### 4. رفع الصور — الوضع الحالي

| المكون | طريقة الرفع | التخزين | الحالة |
|--------|------------|---------|--------|
| **Property (عقار)** | `property.uploadPhoto` — base64 → Sharp → WebP | محلي `uploads/properties/{userId}/` | ✅ يعمل |
| **Building (مبنى)** | ❌ غير موجود | — | ❌ مفقود |
| **Unit (وحدة)** | ❌ غير موجود | — | ❌ مفقود |
| **City (مدينة)** | `admin.uploadCityPhoto` | محلي `uploads/cities/` | ✅ يعمل |
| **User Avatar** | `admin.uploadStaffPhoto` | محلي `uploads/staff/` | ✅ يعمل |
| **CMS Assets** | `siteSettings.uploadAsset` | محلي `uploads/cms/` | ✅ يعمل |
| **Maintenance** | `maintenance.uploadPhoto` | محلي `uploads/maintenance/` | ✅ يعمل |

**ملاحظة مهمة عن Beds24:** Beds24 لا يوفر API لرفع الصور. الصور في Beds24 تُدار من لوحة تحكم Beds24 مباشرة. لذلك **لا يوجد تعارض** — كل نظام يدير صوره بشكل مستقل.

---

### 5. تكامل Beds24 — كيف يعمل

```
العلاقة:
Property (عقار معروض) ←── units.propertyId ──→ Unit (وحدة) ←── beds24_map.unitId ──→ Beds24

التدفق:
1. المدير يُنشئ مبنى (Building)
2. المدير يُنشئ وحدات (Units) داخل المبنى
3. المدير يربط كل وحدة بـ Beds24 عبر beds24_map (API أو iCal)
4. المدير يربط الوحدة بعقار معروض (propertyId) — أو يُنشئ عقار جديد
5. Beds24 يُزامن الحجوزات والتوفر
6. الصور تُدار بشكل مستقل في كل نظام
```

**لا يوجد تعارض في الصور** لأن:
- صور العقار (Property) تُخزن محلياً وتُعرض للمستأجر
- صور Beds24 تُدار في Beds24 وتُعرض في منصات الحجز الأخرى (Booking.com, Airbnb, إلخ)
- النظامان لا يتشاركان الصور

---

## الجداول المفقودة في الإنتاج

هذه الجداول موجودة في `drizzle/schema.ts` لكن **غير منشأة** في قاعدة البيانات الإنتاجية:

| الجدول | الوظيفة | التأثير |
|--------|---------|---------|
| `buildings` | إدارة المباني | ❌ صفحة المباني لا تعمل |
| `units` | إدارة الوحدات | ❌ صفحة الوحدات لا تعمل |
| `beds24_map` | ربط Beds24 | ❌ ربط Beds24 لا يعمل |
| `payment_ledger` | السجل المالي | ❌ المدفوعات المالية لا تعمل |
| `booking_extensions` | التجديدات | ❌ التجديدات لا تعمل |
| `unit_daily_status` | حالة الإشغال اليومية | ❌ تقارير الإشغال لا تعمل |
| `payment_method_settings` | إعدادات Moyasar | ❌ بوابة الدفع لا تعمل |
| `audit_log` | سجل التدقيق | ❌ التدقيق لا يعمل |

**الحل:** تشغيل `npx drizzle-kit push` على قاعدة البيانات الإنتاجية.

---

## الإجراء المطلوب (بالترتيب)

### خطوة 1: إنشاء الجداول المفقودة (حرج)
```bash
# من مجلد المشروع على السيرفر
DATABASE_URL="mysql://..." npx drizzle-kit push
```
هذا سيُنشئ جميع الجداول المفقودة بدون حذف البيانات الموجودة.

### خطوة 2: تشغيل seed-cities (مرة واحدة)
```bash
DATABASE_URL="mysql://..." npx tsx server/seed-cities.ts
```
هذا سيُضيف المدن والأحياء السعودية مع الصور.

### خطوة 3: اختبار الإنشاء
1. إنشاء مبنى من لوحة التحكم
2. إضافة وحدة داخل المبنى
3. ربط الوحدة بـ Beds24
4. إنشاء عقار وربطه بالوحدة

### خطوة 4: (اختياري) إضافة رفع صور للمباني والوحدات
حالياً لا يوجد حقل صور في جداول buildings و units. إذا أردت إضافة صور:
- إضافة عمود `photos json` في الجدولين
- إضافة route `uploadPhoto` مشابه لـ `property.uploadPhoto`
- إضافة واجهة رفع في النماذج

---

## ملخص الحالة النهائي

| المكون | الكود | قاعدة البيانات | يعمل فعلياً؟ |
|--------|-------|---------------|-------------|
| إنشاء عقار + صور | ✅ | ✅ | ✅ نعم |
| عرض العقار | ✅ | ✅ | ✅ نعم |
| إنشاء مبنى | ✅ | ❌ جدول مفقود | ❌ لا |
| إنشاء وحدة | ✅ | ❌ جدول مفقود | ❌ لا |
| ربط Beds24 | ✅ | ❌ جدول مفقود | ❌ لا |
| السجل المالي | ✅ | ❌ جدول مفقود | ❌ لا |
| بوابة الدفع Moyasar | ✅ | ❌ جدول مفقود | ❌ لا |
| التجديدات | ✅ | ❌ جدول مفقود | ❌ لا |
| شعارات الدفع | ✅ | ❌ جدول مفقود | ❌ لا |

**السبب الجذري واحد:** الجداول الجديدة لم تُنشأ في قاعدة البيانات الإنتاجية بعد.

**الحل:** أمر واحد: `npx drizzle-kit push`
